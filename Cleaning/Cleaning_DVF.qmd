---
title: "Cleaning_DVF"
author: "Paul"
format: html
---


# !! IMMPORTANT !! 
If you want to replicate our data you can either download the DVF file from : 
<https://www.data.gouv.fr/datasets/demandes-de-valeurs-foncieres-geolocalisees> 
This file is quite big (3,5Go) so we werent able to upload it on Git, so you can also use the reduced version you can find in DATA_RAW "DVF_Paris_2020_25.rds" this is the same one but reduced to the Paris region and with the good columns. If you're starting from the second option you can skip the next three parts and continue from "Buildind a Price/squaremeter indicator".


#First DVf database (2020-1stSemester2025)
```{r}
library(data.table)
library(sf)
library(dplyr)
library(here)
```

#Keeping the departements we want to look at, same for the columns 
```{r}
Paris <- c("75")


cols_keep <- c(
  "id_mutation",
  "date_mutation",
  "nature_mutation",
  "valeur_fonciere",
  "type_local",
  "code_type_local",
  "surface_reelle_bati",
  "nombre_pieces_principales",
  "surface_terrain",
  "code_postal",
  "code_commune",
  "nom_commune",
  "longitude",
  "latitude",
  "id_parcelle",
  "code_departement"
)

```


#Getting rid of problematic data 
```{r}
DVF_Paris_2020_25 <- fread(
  here("DATA_Raw", "dvf.csv"),
  select = cols_keep
)[
  code_departement %in% Paris &
    type_local %in% c("Appartement", "Maison") &
    !is.na(surface_reelle_bati) &
    surface_reelle_bati > 9 & surface_reelle_bati < 500 &
    valeur_fonciere > 5000 & valeur_fonciere < 5e6 &
    !is.na(longitude) & !is.na(latitude)
]

saveRDS(
  DVF_Paris_2020_25,
  here("DATA_Raw", "DVF_Paris_2020_25.rds")
)

```


#Building a Price/Squaremeter indicator
```{r}
DVF_Paris_2020_25[, prix_m2 := valeur_fonciere / surface_reelle_bati]
```


#Spatial reattchement 
#transforming in lambert 93 (iris format)
```{r}
dvf_sf <- st_as_sf(
  DVF_Paris_2020_25,
  coords = c("longitude", "latitude"),
  crs = 4326              
) |>
  st_transform(2154)      
```

#loading up iris shape file of 2020
```{r}

iris2020 <- st_read(
  here(
    "DATA_Raw",
    "CONTOURS-IRIS_2-1_SHP_LAMB93_FXX-2020",
    "CONTOURS-IRIS.shp"
  ),
  quiet = TRUE
) |>
  st_transform(2154)

names(iris2020)


```
```{r}
dvf_iris <- st_join(
  dvf_sf,
  iris2020[, c("CODE_IRIS", "NOM_IRIS")],   
  left = TRUE
)


dvf_iris <- dvf_iris |> 
  filter(!is.na(CODE_IRIS))

```


```{r}
dvf_iris <- dvf_iris |>
  mutate(
    annee = as.integer(format(as.Date(date_mutation), "%Y"))
  )

```

```{r}

prix_iris_2020_25 <- dvf_iris |>
  st_drop_geometry() |>
  group_by(CODE_IRIS, annee) |>
  summarise(
    prix_m2_med  = median(prix_m2, na.rm = TRUE),
    prix_m2_mean = mean(prix_m2, na.rm = TRUE),
    n_ventes     = n(),
    .groups = "drop"
  ) |>
  filter(n_ventes >= 1)

dir.create(
  here("DATA_Processed"),
  showWarnings = FALSE,
  recursive = TRUE
)

saveRDS(
  prix_iris_2020_25,
  here("DATA_Processed", "prix_iris_2020_25.rds")
)
```

```{r}
nrow(prix_iris_2020_25)               
length(unique(prix_iris_2020_25$CODE_IRIS))  
sort(unique(prix_iris_2020_25$annee))        
```

#DVF 2014-2018

```{r}
dvf2014_18 <- fread(here("DATA_Raw" , "dvf_14_18.csv"))

```
```{r}
IDF_dep <- c("75")

dvf2014_18_IDF <- dvf2014_18 %>%
  filter(code_departement %in% IDF_dep) %>%
  filter(type_local %in% c("Appartement", "Maison"))


```

