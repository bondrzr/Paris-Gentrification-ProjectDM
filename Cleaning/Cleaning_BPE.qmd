---
title: "Cleaning BPE"
author: "Paul"
format: html
---

```{r}
library(sf)
library(dplyr)
library(vroom)
library(here)
library(tidyr)
library(data.table)
```

#Loading the IRIS 2020 File 
```{r}
iris2020 <- st_read(
  here(
    "DATA_Raw",
    "CONTOURS-IRIS_2-1_SHP_LAMB93_FXX-2020",
    "CONTOURS-IRIS.shp"
  ),
  quiet = TRUE
) |>
  st_transform(2154) |>
  filter(substr(CODE_IRIS, 1, 2) == "75") |>
  select(CODE_IRIS, NOM_IRIS)

```



# BPE for 2024

# !! IMMPORTANT !! 
If you want to replicate our data you can either download the BPE 2024 file from : 
<https://data.iledefrance.fr/explore/dataset/bpe23-nettoye/information/>
This file is too big (1,4GO) to be committed onto GITHUB but we've added a reduced version on DATA_Raw "BPE_Paris_2024_iris.rds". This is the same file but already reduced to Paris and keeping the necessary columns. If you're using this one then you can skip the next two codes and go directly to linking IRIS2020 (don't forget to run the previous codes before this message).

#Choosing the appropriate columns
```{r}
bpe_keep <- c(
  "AN", "DEPCOM", "DEP", "REG", "LIBCOM",
  "DCIRIS", "LONGITUDE", "LATITUDE",
  "LAMBERT_X", "LAMBERT_Y", "QUALITE_XY", "NBEQUIDENT" , "QUALITE_GEOLOC", "EPSG",
  "DOM", "SDOM", "TYPEQU", "TYPE", "CATEGORIE"
)

```

#loading up the data
```{r}
BPE_Paris_2024 <- vroom(
  here("DATA_Raw", "BPE24.csv"),
  delim = ";",
  col_select = all_of(bpe_keep),
  show_col_types = FALSE
) |>
  filter(DEP == "75")

saveRDS(
  BPE_Paris_2024,
  here("DATA_Raw", "BPE_Paris_2024.rds")
)
```

#Linking with IRIS 2020

```{r}

BPE_Paris_2024 <-readRDS(here("DATA_Raw" , "BPE_Paris_2024.rds"))

BPE_Paris_2024_sf <- BPE_Paris_2024 |>
  filter(!is.na(LAMBERT_X), !is.na(LAMBERT_Y)) |>
  st_as_sf(
    coords = c("LAMBERT_X", "LAMBERT_Y"),
    crs    = 2154,
    remove = FALSE
  )

BPE_Paris_2024_iris <- st_join(
  BPE_Paris_2024_sf,
  iris2020,
  left = TRUE
) |>
  filter(!is.na(CODE_IRIS)) |>
  mutate(
    annee     = AN,
    iris_2020 = CODE_IRIS
  )

saveRDS(
  BPE_Paris_2024_iris,
  here("DATA_Processed", "BPE_Paris_2024_iris.rds")
)
```




#BPE for 2016
```{r}

BPE_2016 <- vroom(
  here("DATA_Raw", "BPE2016.csv"),
  delim = ";",
  show_col_types = FALSE
)


BPE_2016_clean <- BPE_2016 |>
  separate(
    `Geo Point`,
    into = c("latitude", "longitude"),
    sep = ",",
    convert = TRUE
  ) |>
  filter(!is.na(latitude), !is.na(longitude))

BPE_2016_paris <- BPE_2016_clean |>
  filter(dep == "75")  

saveRDS(
  BPE_2016_paris,
  here("DATA_Raw", "BPE_Paris_2016.rds")
)

```



```{r}
BPE_2016_sf <- BPE_2016_clean |>
  st_as_sf(
    coords = c("longitude", "latitude"),
    crs = 4326,      # WGS84
    remove = FALSE
  ) |>
  st_transform(2154)


BPE_Paris_2016_iris <- st_join(
  BPE_2016_sf,
  iris2020,
  join = st_within,
  left = TRUE
) |>
  filter(!is.na(CODE_IRIS)) |>
  mutate(
    annee     = 2016,
    iris_2020 = CODE_IRIS
  )


saveRDS(
  BPE_Paris_2016_iris,
  here("DATA_Processed", "BPE_Paris_2016_iris.rds")
)

```

#BPE for 2018

```{r}
library(janitor)
library(data.table)
table_passage <- fread(
  here("DATA_Raw", "table_passage_1999_2022.csv")
) %>%
  clean_names()
BPE_2018 <-fread(here("DATA_Raw" , "bpe-2018.csv"))
```

```{r}


BPE_Paris_2018 <- BPE_2018 %>%
  clean_names() %>%
  rename(
    iris_old = code_iris,
    annee    = annee
  ) %>%
  mutate(
    iris_old = as.character(iris_old),
    dep      = substr(iris_old, 1, 2)
  ) %>%
  filter(dep == "75")

saveRDS(
  BPE_Paris_2018,
  here("DATA_Raw", "BPE_Paris_2018.rds")
)
```

```{r}

BPE_Paris_2018 <- BPE_Paris_2018 %>%
  mutate(
    iris_old = gsub("_", "", iris_old)
  )

BPE_Paris_2018_2020 <- BPE_Paris_2018 %>%
  left_join(
    table_passage %>%
      select(code_iris_2018, code_iris_2020),
    by = c("iris_old" = "code_iris_2018")
  ) %>%
  mutate(
    iris_2020 = if_else(
      is.na(code_iris_2020),
      iris_old,          
      code_iris_2020     
    )
  ) %>%
  select(-code_iris_2020)


```

```{r}
library(sf)

iris2020 <- st_read(
  here(
    "DATA_Raw",
    "CONTOURS-IRIS_2-1_SHP_LAMB93_FXX-2020",
    "CONTOURS-IRIS.shp"
  ),
  quiet = TRUE
) |>
  st_transform(2154) |>
  filter(substr(CODE_IRIS, 1, 2) == "75") |>
  select(CODE_IRIS, NOM_IRIS)

```

```{r}
BPE_Paris_2018_iris <- iris2020 %>%
  left_join(
    BPE_Paris_2018_2020,
    by = c("CODE_IRIS" = "iris_2020")
  )

saveRDS(
  BPE_Paris_2018_iris,
  here("DATA_Processed", "BPE_Paris_2018_iris.rds")
)
```

