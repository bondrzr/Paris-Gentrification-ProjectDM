---
title: "DVF_Analysis"
format: html
author: "Matei Vasile"
---

```{r}
library(data.table)
library(dplyr)
library(purrr)
library(broom)
library(scales)
library(here)
library(tidyr)
```


#DVF index
```{r}
file <- here("DATA_Processed", "prix_iris_2014_25.rds")

df <- readRDS(file)

yoy <- df %>%
  arrange(CODE_IRIS, annee) %>%
  group_by(CODE_IRIS) %>%
  mutate(growth = prix_m2_med / lag(prix_m2_med) - 1) %>%
  ungroup() %>%
  filter(!is.na(growth))

bench <- yoy %>%
  group_by(annee) %>%
  summarise(avg_growth = mean(growth, na.rm = TRUE), .groups = "drop")

rel <- yoy %>%
  left_join(bench, by = "annee") %>%
  mutate(rel_growth = growth - avg_growth)

iris_overall <- rel %>%
  group_by(CODE_IRIS) %>%
  summarise(
    mean_rel_growth = mean(rel_growth, na.rm = TRUE),
    n_years = n(),
    index_score = (1 + mean_rel_growth),
    .groups = "drop"
  ) %>%
  filter(n_years >= 5) %>%
  arrange(desc(mean_rel_growth))

View(iris_overall)
```


#Population index

#Creating new variables 
```{r}
JOB_all <- readRDS(here("DATA_Processed", "JOB_all.rds"))

JOB_all_clean <- JOB_all |>
  filter(actocc1564 > 0, act1564 > 0) |>
  mutate(
    share_csp_sup   = (cadres_1564 + prof_inter_1564) / actocc1564,  
    share_populaire = (employes_1564 + ouvriers_1564) / actocc1564,
    share_chom      = chom1564 / act1564
  )
```

#New base calculating slopes 
```{r}
JOB_gentrification <- JOB_all_clean |>
  select(
    iris_2020,
    annee,
    share_csp_sup,
    share_populaire,
    share_chom
  )

get_slope <- function(df, var) {
  lm(as.formula(paste(var, "~ annee")), data = df) |>
    broom::tidy() |>
    filter(term == "annee") |>
    pull(estimate)
}
```

```{r}
dynamics_IRIS <- JOB_gentrification |>
  group_by(iris_2020) |>
  filter(n() >= 4) |>
  nest() |>
  mutate(
    slope_CSP_plus = map_dbl(data, ~ get_slope(.x, "share_csp_sup")),
    slope_CSP_pop  = map_dbl(data, ~ get_slope(.x, "share_populaire")),
    slope_chom     = map_dbl(data, ~ get_slope(.x, "share_chom"))
  ) |>
  select(-data) |>
  ungroup()

dynamics_IRIS <- dynamics_IRIS |>
  mutate(
    Z_CSP_plus = as.numeric(scale(slope_CSP_plus)),
    Z_CSP_pop  = as.numeric(scale(slope_CSP_pop)),
    Z_chom     = as.numeric(scale(slope_chom))
  )


dynamics_IRIS <- dynamics_IRIS |>
  mutate(
    index_pop = Z_CSP_plus - Z_CSP_pop - Z_chom
  ) |>
  arrange(desc(index_pop)) 

head(dynamics_IRIS)
```

