---
title: "FILOSOFI_Analysis"
format: html
---

```{r}
library(dplyr)
library(here)
```

```{r}
df_raw <- readRDS(
  here("DATA_Processed", "filo_final.rds")
)
```

```{r}
df_index <- df_raw %>%
  transmute(iris_lib, commune, commune_lib, taux_de_bas_revenus_declares_au_seuil_de_60_percent_percent, mediane, indice_de_gini, x1er_decile, annee, iris = iris_2020, dep)

df_new <- df_index %>%
  mutate(mediane = as.numeric(mediane))

```
```{r}
# STEP 1: Collapse to one median income per IRIS–year
df_income <- df_new %>%
  group_by(iris, annee) %>%
  summarise(
    mediane = median(mediane, na.rm = TRUE),
    .groups = "drop"
  )

# STEP 2: Compute annualised year-on-year income growth per IRIS
income_yoy <- df_income %>%
  arrange(iris, annee) %>%
  group_by(iris) %>%
  mutate(
    year_gap = annee - lag(annee),
    income_growth = (mediane / lag(mediane))^(1 / year_gap) - 1
  ) %>%
  ungroup() %>%
  filter(!is.na(income_growth))

# STEP 3: Compute yearly “market” benchmark income growth
income_bench <- income_yoy %>%
  group_by(annee) %>%
  summarise(
    avg_income_growth = mean(income_growth, na.rm = TRUE),
    .groups = "drop"
  )

# STEP 4: Compute relative income growth and cumulate into a base-1 index
income_overall <- income_yoy %>%
  left_join(income_bench, by = "annee") %>%
  mutate(
    rel_income_growth = income_growth - avg_income_growth
  ) %>%
  arrange(iris, annee) %>%
  group_by(iris) %>%
  summarise(
    income_index_score_1 = last(cumprod(1 + rel_income_growth)),
    mean_rel_income_growth = mean(rel_income_growth, na.rm = TRUE),
    n_years = n_distinct(annee),
    .groups = "drop"
  ) %>%
  filter(n_years >= 2) %>%
  arrange(desc(income_index_score_1))

View(income_overall)
```

